---
phase: 01-foundation
plan: "04"
type: execute
wave: 4
depends_on:
  - "01-03"
files_modified: []
autonomous: false
requirements:
  - Terminal Lifecycle and Safety
  - SQLite Configuration constraints

must_haves:
  truths:
    - "Intentional panic restores terminal — no manual reset needed"
    - "SIGTERM causes clean exit and terminal restore"
    - "sqlite3 PRAGMA journal_mode returns 'wal'"
    - "cargo build --workspace exits 0 with zero errors"
  artifacts:
    - path: ".airev/reviews.db"
      provides: "SQLite database file created by open_db()"
      contains: "WAL journal mode"
  key_links:
    - from: ".airev/reviews.db"
      to: "WAL journal mode"
      via: "sqlite3 .airev/reviews.db 'PRAGMA journal_mode;' returns 'wal'"
      pattern: "wal"
---

<objective>
Verify the phase exit criteria through hands-on testing: panic recovery, SIGTERM handling, WAL mode confirmation, and full workspace build.

Purpose: These tests cannot be automated (they require visual terminal inspection and live process signaling). This checkpoint closes Phase 1 — the results confirm the TUI shell is production-grade before any features are built on top of it.
Output: Human confirmation that all four exit criteria pass. No code changes expected — if tests fail, roll back to the relevant prior plan to fix the underlying issue.
</objective>

<execution_context>
@/Users/juliusalexandre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/juliusalexandre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Phase 1 exit criteria verification</name>
  <action>
Run all four verification tests listed in how-to-verify. No code changes needed unless a test fails — if a test fails, identify which prior plan introduced the defect and fix it there before re-running this checkpoint.
  </action>
  <what-built>
Complete Phase 1 TUI shell: Cargo workspace with airev/airev-mcp/airev-core, stderr terminal backend with panic hook, SIGTERM handler, event loop with 50ms heartbeat, blank 3-panel layout, and WAL-mode SQLite database.
  </what-built>
  <how-to-verify>
Run each test in sequence. All four must pass.

**Test 1 — Workspace build:**
```bash
cargo build --workspace
```
Expected: exits 0, zero errors, three binaries/libraries compiled.

**Test 2 — Panic recovery:**
```bash
# In a real terminal (not a subprocess or CI):
cargo run -p airev
# Wait for the 3-panel layout to appear.
# In a second terminal tab, send SIGABRT to force a panic-like crash:
kill -ABRT $(pgrep airev)
```
Expected: Terminal returns to normal shell prompt immediately. The panic message appears on stderr. Running `echo hello` works normally — no `reset` needed.

Fail condition: Terminal stays in raw mode or alternate screen after the process dies. If this happens, type `reset` and report which symptoms appeared.

**Test 3 — SIGTERM clean exit:**
```bash
# Run airev in one terminal:
cargo run -p airev

# In another terminal, send SIGTERM within 2 seconds:
kill -TERM $(pgrep airev)
```
Expected: The TUI exits within 50ms of SIGTERM. Terminal is restored — normal prompt appears. No `reset` needed.

Fail condition: Process does not exit (must use `kill -KILL`). Or process exits but terminal is left in raw mode/alternate screen.

**Test 4 — WAL mode confirmation:**
```bash
# Run airev briefly to create the DB, then quit with 'q':
cargo run -p airev

# Inspect the database:
sqlite3 .airev/reviews.db 'PRAGMA journal_mode;'
sqlite3 .airev/reviews.db '.tables'
sqlite3 .airev/reviews.db '.schema threads'
sqlite3 .airev/reviews.db '.schema comments'
```
Expected:
- `PRAGMA journal_mode;` returns `wal` (not `delete` or `memory`)
- `.tables` shows: `comments  sessions  threads`
- `.schema comments` shows `thread_id` column and `CHECK(severity IN ...)` constraint
- `.schema threads` shows `round_number` and `status` columns with the enum CHECK
  </how-to-verify>
  <verify>
All four tests pass as described in how-to-verify. Terminal restores after panic. SIGTERM exits cleanly. PRAGMA journal_mode returns wal. cargo build --workspace exits 0.
  </verify>
  <done>
Human has confirmed all four Phase 1 exit criteria pass.
  </done>
  <resume-signal>
Type "approved" if all four tests pass. Or describe which test failed and what symptom appeared (e.g., "Test 2 failed: terminal stayed in raw mode after SIGABRT").
  </resume-signal>
</task>

</tasks>

<verification>
All four exit criteria from ROADMAP.md Phase 1 confirmed by human testing:
1. Panic test: terminal restores without `reset`
2. SIGTERM test: clean exit within 50ms
3. WAL test: `sqlite3 .airev/reviews.db 'PRAGMA journal_mode;'` returns `wal`
4. Build test: `cargo build --workspace` exits 0
</verification>

<success_criteria>
Human confirms all four tests pass. Phase 1 is complete. The foundation is stable enough to build Phase 2 (Rendering Skeleton) on top of it.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md` following the template at @/Users/juliusalexandre/.claude/get-shit-done/templates/summary.md
</output>
