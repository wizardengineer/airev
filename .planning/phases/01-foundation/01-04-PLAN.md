---
phase: 01-foundation
plan: "04"
type: execute
wave: 4
depends_on:
  - "01-03"
files_modified: []
autonomous: false
requirements:
  - Terminal Lifecycle and Safety
  - SQLite Configuration constraints

must_haves:
  truths:
    - "Intentional panic restores terminal — no manual reset needed"
    - "SIGTERM causes clean exit and terminal restore"
    - "sqlite3 PRAGMA journal_mode returns 'wal'"
    - "cargo build --workspace exits 0 with zero errors"
    - "Startup to first rendered frame is under 100ms (no blocking I/O before first draw)"
  artifacts:
    - path: ".airev/reviews.db"
      provides: "SQLite database file created by open_db()"
      contains: "WAL journal mode"
  key_links:
    - from: ".airev/reviews.db"
      to: "WAL journal mode"
      via: "sqlite3 .airev/reviews.db 'PRAGMA journal_mode;' returns 'wal'"
      pattern: "wal"
---

<objective>
Verify the phase exit criteria through hands-on testing: panic recovery, SIGTERM handling, WAL mode confirmation, full workspace build, and startup timing.

Purpose: These tests cannot be automated (they require visual terminal inspection and live process signaling). This checkpoint closes Phase 1 — the results confirm the TUI shell is production-grade before any features are built on top of it.
Output: Human confirmation that all five exit criteria pass. No code changes expected — if tests fail, roll back to the relevant prior plan to fix the underlying issue.
</objective>

<execution_context>
@/Users/juliusalexandre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/juliusalexandre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
</context>

<tasks>

<task type="auto">
  <name>Automated pre-check: build, WAL mode, startup timing</name>
  <files>.airev/reviews.db</files>
  <action>
Run the three automatable Phase 1 exit criteria as scripted checks. All three must pass
before the human verification step runs.

**Check 1 — Workspace build:**
```bash
cargo build --workspace 2>&1
if [ $? -ne 0 ]; then
  echo "FAIL: cargo build --workspace exited non-zero"
  exit 1
fi
echo "PASS: cargo build --workspace"
```

**Check 2 — WAL mode:**
Run airev briefly (send 'q' via stdin), then inspect the database:
```bash
echo q | cargo run -p airev -- 2>/dev/null || true
JOURNAL=$(sqlite3 .airev/reviews.db 'PRAGMA journal_mode;' 2>/dev/null)
if [ "$JOURNAL" != "wal" ]; then
  echo "FAIL: PRAGMA journal_mode returned '$JOURNAL', expected 'wal'"
  exit 1
fi
echo "PASS: journal_mode = $JOURNAL"
```

**Check 3 — Startup timing (informational, not blocking):**
```bash
START=$(date +%s%3N)
echo q | cargo run -p airev -- 2>/dev/null || true
END=$(date +%s%3N)
MS=$((END - START))
echo "Startup + quit round-trip: ${MS}ms (warm build cache — subtract cargo overhead manually)"
if [ $MS -gt 5000 ]; then
  echo "WARN: startup took over 5s — investigate cold-start path"
fi
```
Note: `time cargo run` includes cargo's own overhead on a warm cache. The 100ms threshold
from the exit criteria refers to the UI appearing after the binary starts, which requires
visual confirmation (Test 5 in the human checkpoint below). This check flags pathological
slowness (>5s) only.

If any check exits non-zero, fix the underlying issue in the appropriate prior plan before
proceeding to the human verification step.
  </action>
  <verify>
All three bash blocks exit 0 (or print PASS). `sqlite3 .airev/reviews.db 'PRAGMA journal_mode;'`
returns `wal`. `cargo build --workspace` exits 0.
  </verify>
  <done>
All automatable checks pass: workspace compiles, WAL confirmed, startup within threshold.
Execution proceeds automatically to the human-verify checkpoint.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Phase 1 exit criteria verification</name>
  <action>
Run all five verification tests listed in how-to-verify. No code changes needed unless a test fails — if a test fails, identify which prior plan introduced the defect and fix it there before re-running this checkpoint.
  </action>
  <what-built>
Complete Phase 1 TUI shell: Cargo workspace with airev/airev-mcp/airev-core, stderr terminal backend with panic hook, SIGTERM handler, event loop with 50ms heartbeat, blank 3-panel layout, and WAL-mode SQLite database.
  </what-built>
  <how-to-verify>
Run each test in sequence. All five must pass.

**Test 1 — Workspace build:**
```bash
cargo build --workspace
```
Expected: exits 0, zero errors, three binaries/libraries compiled.

**Test 2 — Panic recovery:**
```bash
# In a real terminal (not a subprocess or CI):
cargo run -p airev
# Wait for the 3-panel layout to appear.
# In a second terminal tab, send SIGABRT to force a panic-like crash:
kill -ABRT $(pgrep airev)
```
Expected: Terminal returns to normal shell prompt immediately. The panic message appears on stderr. Running `echo hello` works normally — no `reset` needed.

Fail condition: Terminal stays in raw mode or alternate screen after the process dies. If this happens, type `reset` and report which symptoms appeared.

**Test 3 — SIGTERM clean exit:**
```bash
# Run airev in one terminal:
cargo run -p airev

# In another terminal, send SIGTERM within 2 seconds:
kill -TERM $(pgrep airev)
```
Expected: The TUI exits within 50ms of SIGTERM. Terminal is restored — normal prompt appears. No `reset` needed.

Fail condition: Process does not exit (must use `kill -KILL`). Or process exits but terminal is left in raw mode/alternate screen.

**Test 4 — WAL mode confirmation:**
```bash
# Run airev briefly to create the DB, then quit with 'q':
cargo run -p airev

# Inspect the database:
sqlite3 .airev/reviews.db 'PRAGMA journal_mode;'
sqlite3 .airev/reviews.db '.tables'
sqlite3 .airev/reviews.db '.schema threads'
sqlite3 .airev/reviews.db '.schema comments'
```
Expected:
- `PRAGMA journal_mode;` returns `wal` (not `delete` or `memory`)
- `.tables` shows: `comments  sessions  threads`
- `.schema comments` shows `thread_id` column and `CHECK(severity IN ...)` constraint
- `.schema threads` shows `round_number` and `status` columns with the enum CHECK

**Test 5 — Startup timing:**
```bash
time cargo run -p airev
# Immediately press 'q' after the UI appears.
```
Expected: The 3-panel layout appears within 100ms of the process starting (the "real" time for the `airev` startup portion should be under 100ms on a warm cargo build cache). Visually: the layout should appear nearly instantaneously — no visible delay between pressing Enter and seeing the bordered panels.

Fail condition: Visible delay of more than 1 second before the UI appears.
  </how-to-verify>
  <verify>
All five tests pass as described in how-to-verify. Terminal restores after panic. SIGTERM exits cleanly. PRAGMA journal_mode returns wal. cargo build --workspace exits 0. Startup to first frame is under 100ms.
  </verify>
  <done>
Human has confirmed all five Phase 1 exit criteria pass.
  </done>
  <resume-signal>
Type "approved" if all five tests pass. Or describe which test failed and what symptom appeared (e.g., "Test 2 failed: terminal stayed in raw mode after SIGABRT").
  </resume-signal>
</task>

</tasks>

<verification>
All five exit criteria from ROADMAP.md Phase 1 confirmed by human testing:
1. Panic test: terminal restores without `reset`
2. SIGTERM test: clean exit within 50ms
3. WAL test: `sqlite3 .airev/reviews.db 'PRAGMA journal_mode;'` returns `wal`
4. Build test: `cargo build --workspace` exits 0
5. Startup timing test: layout appears within 100ms on a warm build cache
</verification>

<success_criteria>
Human confirms all five tests pass. Phase 1 is complete. The foundation is stable enough to build Phase 2 (Rendering Skeleton) on top of it.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md` following the template at @/Users/juliusalexandre/.claude/get-shit-done/templates/summary.md
</output>
