---
phase: 03-git-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Cargo.toml
  - airev/Cargo.toml
  - airev/src/git/types.rs
  - airev/src/event.rs
autonomous: true
requirements:
  - Diff View
  - Diff Modes
  - Git Integration

must_haves:
  truths:
    - "cargo build --workspace compiles without errors after adding git2/crossbeam-channel/syntect/syntect-tui/similar"
    - "OwnedDiffHunk, OwnedDiffLine, FileSummary, DiffMode, GitResultPayload are all owned (no lifetimes) and implement Send"
    - "AppEvent::GitResult(Box<GitResultPayload>) carries real payload — not a unit variant"
    - "DiffMode has four variants: Unstaged, Staged, CommitRange, BranchComparison"
  artifacts:
    - path: "airev/src/git/types.rs"
      provides: "OwnedDiffHunk, OwnedDiffLine, FileSummary, DiffMode, GitRequest, GitResult, GitResultPayload"
      exports: [OwnedDiffHunk, OwnedDiffLine, FileSummary, DiffMode, GitRequest, GitResultPayload]
    - path: "airev/src/event.rs"
      provides: "AppEvent::GitResult(Box<GitResultPayload>) variant with payload"
      contains: "GitResult(Box<GitResultPayload>)"
  key_links:
    - from: "airev/src/event.rs"
      to: "airev/src/git/types.rs"
      via: "use crate::git::types::GitResultPayload"
      pattern: "GitResultPayload"
---

<objective>
Add the five new Cargo dependencies (git2, crossbeam-channel, syntect, syntect-tui, similar) and define all owned data types that flow from the git background thread to the render path. Upgrade AppEvent::GitResult from a unit variant placeholder to a real data-carrying variant.

Purpose: Every subsequent plan in Phase 3 depends on these types. Getting them correct and compiling first — with no borrowed lifetimes — eliminates the most likely integration failures downstream.

Output: Compiling workspace with all Phase 3 deps, `airev/src/git/types.rs` with all owned structs, `AppEvent::GitResult(Box<GitResultPayload>)` carrying highlighted lines, file summaries, and hunk offsets.
</objective>

<execution_context>
@/Users/juliusalexandre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/juliusalexandre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-git-layer/03-RESEARCH.md
@airev/src/event.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add workspace and crate Cargo dependencies</name>
  <files>Cargo.toml, airev/Cargo.toml</files>
  <action>
    In `Cargo.toml` (workspace root), add to `[workspace.dependencies]`:

    ```toml
    git2              = "0.20"
    crossbeam-channel = "0.5"
    syntect           = { version = "5.3", default-features = false, features = ["default-fancy"] }
    syntect-tui       = "3.0"
    similar           = { version = "2.7", features = ["inline"] }
    ```

    In `airev/Cargo.toml`, add to `[dependencies]`:

    ```toml
    git2              = { workspace = true }
    crossbeam-channel = { workspace = true }
    syntect           = { workspace = true }
    syntect-tui       = { workspace = true }
    similar           = { workspace = true }
    ```

    After editing, run `cargo build --workspace` to confirm all deps resolve.
    The `default-fancy` feature on syntect pulls in the pure-Rust fancy-regex
    crate instead of Oniguruma (no C build dep). Do NOT add these deps to
    `airev-mcp` or `airev-core` — git and diff logic belongs only in `airev`.
  </action>
  <verify>
    `cargo build --workspace` exits 0. `cargo tree -p airev | grep git2` shows
    git2 0.20.x. `cargo tree -p airev | grep syntect` shows syntect 5.3.x with
    default-fancy feature. No linker errors for Oniguruma (pure-Rust path).
  </verify>
  <done>workspace builds with zero errors after adding all five dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create git/types.rs with owned diff structs and AppEvent payload</name>
  <files>airev/src/git/types.rs, airev/src/event.rs</files>
  <action>
    Create directory `airev/src/git/` and file `airev/src/git/types.rs`. Also create
    `airev/src/git/mod.rs` as a minimal module root (just re-exports from types.rs) so
    the module compiles — the full `AsyncGit` impl comes in Plan 02.

    `airev/src/git/mod.rs`:
    ```rust
    //! Git integration for airev.
    //!
    //! The git module exposes an `AsyncGit` facade that owns a background
    //! `std::thread::spawn` thread. The thread holds the `git2::Repository` for
    //! its lifetime — Repository is !Send, so it must never cross a thread boundary.
    pub mod types;
    pub mod worker;
    ```

    Create `airev/src/git/worker.rs` as a stub (just a public empty function) so mod.rs
    compiles. The real worker loop comes in Plan 02:
    ```rust
    //! Background thread worker — stub. Implemented in Plan 02.
    ```

    `airev/src/git/types.rs` must contain:

    1. `OwnedDiffLine` — owned line of diff output:
       ```rust
       #[derive(Debug, Clone)]
       pub struct OwnedDiffLine {
           /// Origin character: '+' added, '-' removed, ' ' context, 'H' hunk header, 'F' file header.
           pub origin: char,
           /// Full line content including trailing newline (owned — safe to send).
           pub content: String,
           pub old_lineno: Option<u32>,
           pub new_lineno: Option<u32>,
       }
       ```

    2. `OwnedDiffHunk` — one @@ block:
       ```rust
       #[derive(Debug, Clone)]
       pub struct OwnedDiffHunk {
           pub header: String,
           pub old_start: u32,
           pub new_start: u32,
           pub lines: Vec<OwnedDiffLine>,
       }
       ```

    3. `FileSummary` — per-file stats for the file-list panel:
       ```rust
       #[derive(Debug, Clone)]
       pub struct FileSummary {
           pub path: String,
           /// 'M' modified, 'A' added, 'D' deleted, 'R' renamed.
           pub status: char,
           pub added: usize,
           pub removed: usize,
       }
       ```

    4. `DiffMode` — the four diff modes:
       ```rust
       #[derive(Debug, Clone, Copy, PartialEq, Eq, Default)]
       pub enum DiffMode {
           #[default]
           Unstaged,        // git diff (workdir vs index)
           Staged,          // git diff --cached (index vs HEAD)
           CommitRange,     // git diff A..B
           BranchComparison,// git diff main..HEAD
       }
       ```

    5. `GitRequest` — commands sent to the worker thread:
       ```rust
       #[derive(Debug)]
       pub enum GitRequest {
           LoadDiff(DiffMode),
           /// For CommitRange: two ref strings (from, to).
           LoadDiffRange { from: String, to: String },
       }
       ```

    6. `GitResultPayload` — result sent back via AppEvent:
       ```rust
       #[derive(Debug)]
       pub struct GitResultPayload {
           pub mode: DiffMode,
           pub hunks: Vec<OwnedDiffHunk>,
           pub files: Vec<FileSummary>,
           /// Pre-highlighted lines for the diff panel (computed in background thread).
           pub highlighted_lines: Vec<ratatui::text::Line<'static>>,
           /// Line indices of hunk header lines within highlighted_lines (for [/] nav).
           pub hunk_offsets: Vec<usize>,
       }
       ```

    All structs must derive `Debug`. `OwnedDiffHunk`, `OwnedDiffLine`, `FileSummary` derive
    `Clone` (needed for storing in AppState and cloning for keybinding responses).
    `GitResultPayload` does NOT need Clone — it is moved into AppState on receipt.

    Add Google-style docstrings to every public symbol.

    After creating types.rs, update `airev/src/event.rs`: change the unit variant
    `GitResult` to `GitResult(Box<GitResultPayload>)`.

    ```rust
    // In event.rs, replace:
    //   GitResult,
    // with:
    //   GitResult(Box<crate::git::types::GitResultPayload>),
    ```

    Add `mod git;` to `airev/src/main.rs` so the module tree is visible. The `_` arm
    in `main.rs` (`_ => {}`) already handles unknown AppEvent variants because of
    `#[non_exhaustive]` — no match arm changes needed in main.rs for the variant
    signature change (new payload-carrying variant is still covered by `_ => {}`).

    Verify the module compiles:
    `cargo build -p airev 2>&1`

    Expected: zero errors. If any `non-exhaustive patterns` errors appear in existing
    match arms that explicitly matched the old unit `GitResult`, fix them by adding
    the `(payload)` binding. The only explicit match in existing code is the `_ => {}`
    arm in main.rs which is already catch-all.
  </action>
  <verify>
    `cargo build -p airev` exits 0.
    `grep -r "GitResult" airev/src/` shows `GitResult(Box<GitResultPayload>)` in event.rs
    and the types are defined in git/types.rs.
    `cargo check -p airev` shows zero warnings for unused imports (if warnings appear,
    add `#[allow(dead_code)]` to types not yet used — they will be used in Plan 02).
  </verify>
  <done>
    airev crate compiles with all five new deps and owned git types. AppEvent::GitResult
    carries a Box&lt;GitResultPayload&gt;. No borrowed lifetimes anywhere in git/types.rs.
    All public symbols have Google-style docstrings.
  </done>
</task>

</tasks>

<verification>
Run `cargo build --workspace` — must exit 0 with zero errors.
Run `cargo check --workspace` and confirm no E0277 (Send/Sync violations) on any new types.
Manually confirm `GitResultPayload::highlighted_lines` is `Vec<ratatui::text::Line<'static>>`
(static lifetime — safe to store in AppState without arena allocation).
</verification>

<success_criteria>
- `cargo build --workspace` exits 0
- `airev/src/git/types.rs` exists and exports OwnedDiffHunk, OwnedDiffLine, FileSummary, DiffMode, GitRequest, GitResultPayload
- `AppEvent::GitResult(Box<GitResultPayload>)` is in event.rs (not unit variant)
- No borrowed lifetimes in types.rs (all fields are owned: String, u32, char, Vec, usize)
- All five deps (git2, crossbeam-channel, syntect, syntect-tui, similar) in workspace Cargo.toml
</success_criteria>

<output>
After completion, create `.planning/phases/03-git-layer/03-01-SUMMARY.md`
</output>
