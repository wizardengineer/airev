---
phase: 03-git-layer
plan: 03
type: execute
wave: 3
depends_on: [03-02]
files_modified:
  - airev/src/ui/diff_view.rs
  - airev/src/ui/file_tree.rs
  - airev/src/ui/mod.rs
autonomous: true
requirements:
  - Diff View
  - File List Panel

must_haves:
  truths:
    - "Diff panel renders from AppState.diff_lines using a List widget with manual slice — not Paragraph"
    - "Only lines[diff_scroll..diff_scroll+viewport_height] are passed to the List widget per frame"
    - "File list panel renders real FileSummary data with M/A/D/R badge, filename, and +N/-N counts"
    - "build_diff_placeholder() and build_comments_placeholder() removed from ui/mod.rs"
    - "cargo build --workspace exits 0 after replacing placeholder renderers with real ones"
  artifacts:
    - path: "airev/src/ui/diff_view.rs"
      provides: "render_diff() using virtual List scrolling from AppState.diff_lines"
      exports: [render_diff]
    - path: "airev/src/ui/file_tree.rs"
      provides: "render_file_list() using AppState.file_summaries with status badges"
      exports: [render_file_list]
    - path: "airev/src/ui/mod.rs"
      provides: "Updated render() calling render_diff and render_file_list from new modules"
  key_links:
    - from: "airev/src/ui/mod.rs"
      to: "airev/src/ui/diff_view.rs"
      via: "diff_view::render_diff(frame, center, focus, state, theme)"
      pattern: "diff_view::render_diff"
    - from: "airev/src/ui/mod.rs"
      to: "airev/src/ui/file_tree.rs"
      via: "file_tree::render_file_list(frame, left, focus, state, theme)"
      pattern: "file_tree::render_file_list"
---

<objective>
Replace the placeholder `render_diff` and `render_file_list` functions in `ui/mod.rs` with dedicated modules using real data from AppState. The diff panel switches from `Paragraph::scroll` to a `List` widget with manual virtual scrolling. The file list panel renders real `FileSummary` data with status badges.

Purpose: This is the visible output of Phase 3 — what the user actually sees. Getting the virtual scrolling correct (only visible lines passed to List) is the performance-critical requirement for 60fps on 5000+ line diffs.

Output: `ui/diff_view.rs` and `ui/file_tree.rs` as standalone render modules; `ui/mod.rs` updated to call them.
</objective>

<execution_context>
@/Users/juliusalexandre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/juliusalexandre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-git-layer/03-RESEARCH.md
@.planning/phases/03-git-layer/03-02-SUMMARY.md
@airev/src/ui/mod.rs
@airev/src/app.rs
@airev/src/ui/layout.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ui/diff_view.rs with virtual List scrolling</name>
  <files>airev/src/ui/diff_view.rs</files>
  <action>
    Create `airev/src/ui/diff_view.rs`. This module replaces the `render_diff` inline function
    in `ui/mod.rs` and is the performance-critical rendering path for the diff panel.

    **Virtual scrolling contract (must not be violated):**
    - `AppState.diff_lines` holds ALL highlighted lines for the current diff (may be 5000+).
    - `AppState.diff_scroll` is the first visible line index (usize).
    - Only `&state.diff_lines[visible_start..visible_end]` is passed to the List widget.
    - `visible_start = state.diff_scroll.min(total.saturating_sub(1))` (clamp to valid range).
    - `visible_end = (visible_start + viewport_height).min(total)`.
    - This means the render closure is O(viewport_height) not O(diff_lines.len()).

    **`render_diff` function** (public, ≤50 lines):

    ```rust
    //! Diff panel renderer for airev.
    //!
    //! Renders the centre diff panel using a List widget with manual virtual scrolling.
    //! Only lines[diff_scroll..diff_scroll+viewport_height] are passed to the List per frame,
    //! making rendering O(viewport) not O(total_lines). This enables 5000+ line diffs at 60fps.

    use ratatui::{
        Frame,
        text::Line,
        widgets::{List, ListItem},
    };

    use crate::app::{AppState, PanelFocus};
    use crate::theme::Theme;
    use crate::ui::layout::{inner_rect, panel_block};

    /// Renders the diff centre panel using virtual List scrolling.
    ///
    /// Only the visible window of `state.diff_lines` is materialized into ListItems per frame.
    /// If `state.diff_lines` is empty, shows a "No diff loaded" placeholder.
    pub fn render_diff(
        frame: &mut Frame,
        area: ratatui::layout::Rect,
        focus: PanelFocus,
        state: &AppState,
        theme: &Theme,
    ) {
        let is_focused = focus == PanelFocus::Diff;
        let block = panel_block("Diff", is_focused, theme);
        let inner = inner_rect(area);
        let viewport_height = inner.height as usize;

        frame.render_widget(block, area);

        if state.diff_lines.is_empty() {
            // Show placeholder when no diff is loaded yet.
            let msg = if state.diff_loading {
                "Computing diff..."
            } else {
                "No diff loaded. Start in a git repository."
            };
            let items = vec![ListItem::new(Line::raw(msg))];
            let list = List::new(items);
            frame.render_widget(list, inner);
            return;
        }

        let total = state.diff_lines.len();
        let visible_start = state.diff_scroll.min(total.saturating_sub(1));
        let visible_end = (visible_start + viewport_height).min(total);

        let items: Vec<ListItem> = state.diff_lines[visible_start..visible_end]
            .iter()
            .map(|l| ListItem::new(l.clone()))
            .collect();

        let list = List::new(items);
        frame.render_widget(list, inner);
    }
    ```

    Note: `inner_rect` and `panel_block` are already pub in `ui/layout.rs` — import directly.
    The `List` widget does not use `ListState` here — the virtual scroll offset is managed
    manually in `AppState.diff_scroll` rather than by ratatui's built-in selection highlight.
    This is correct: we want the top-of-viewport to be line N, not ratatui selection behavior.

    After creating the file, add `pub mod diff_view;` to `airev/src/ui/mod.rs`.
    Run `cargo check -p airev` to confirm the new module compiles.
  </action>
  <verify>
    `cargo check -p airev` exits 0.
    `grep "virtual" airev/src/ui/diff_view.rs` returns the virtual scrolling comment.
    `grep "Paragraph" airev/src/ui/diff_view.rs` returns empty — no Paragraph widget used.
    The visible_start/visible_end slice logic is bounded: start ≤ end ≤ total.
  </verify>
  <done>
    diff_view.rs compiles. Uses List widget with manual slice. render_diff is public and exported.
    Empty-state placeholder shown when diff_lines is empty. No Paragraph, no u16 offset.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ui/file_tree.rs and update ui/mod.rs</name>
  <files>airev/src/ui/file_tree.rs, airev/src/ui/mod.rs</files>
  <action>
    Create `airev/src/ui/file_tree.rs` with real file list rendering, then update
    `ui/mod.rs` to use both new modules and remove placeholder builders.

    **`file_tree.rs` — `render_file_list` function** (public, ≤50 lines):

    ```rust
    //! File list panel renderer for airev.
    //!
    //! Renders the left file-list panel from AppState.file_summaries. Each entry shows
    //! a status badge (M/A/D/R), filename, and +N/-N change counts. When file_summaries
    //! is empty, shows a "No files" placeholder matching the diff loading state.

    use ratatui::{
        Frame,
        style::{Color, Style, Stylize as _},
        text::{Line, Span},
        widgets::{List, ListItem},
    };

    use crate::app::{AppState, PanelFocus};
    use crate::git::types::FileSummary;
    use crate::theme::Theme;
    use crate::ui::layout::{panel_block};

    /// Renders the file-list left panel from `AppState.file_summaries`.
    ///
    /// Uses `render_stateful_widget` so the ListState selection highlight is applied.
    /// File count is shown in the panel title block (e.g., "Files (12)").
    pub fn render_file_list(
        frame: &mut Frame,
        area: ratatui::layout::Rect,
        focus: PanelFocus,
        state: &mut AppState,
        theme: &Theme,
    ) {
        let is_focused = focus == PanelFocus::FileList;
        let file_count = state.file_summaries.len();
        let title = if file_count > 0 {
            format!("Files ({})", file_count)
        } else {
            "Files".to_owned()
        };
        let block = panel_block(&title, is_focused, theme);

        let items: Vec<ListItem> = if state.file_summaries.is_empty() {
            let msg = if state.diff_loading { "Loading..." } else { "No files" };
            vec![ListItem::new(Line::raw(msg))]
        } else {
            state.file_summaries.iter().map(|f| file_summary_item(f, theme)).collect()
        };

        let list = List::new(items)
            .block(block)
            .highlight_style(Style::default().fg(theme.border_active));

        frame.render_stateful_widget(list, area, &mut state.file_list_state);
    }

    /// Converts a FileSummary into a styled ListItem.
    ///
    /// Format: `[M] src/main.rs  +42 -7`
    /// Badge colors: M=Yellow, A=Green, D=Red, R=Cyan.
    fn file_summary_item(f: &FileSummary, _theme: &Theme) -> ListItem<'static> {
        let badge_color = match f.status {
            'A' => Color::Green,
            'D' => Color::Red,
            'R' => Color::Cyan,
            _ => Color::Yellow,  // 'M' and anything else
        };
        let badge = Span::styled(
            format!("[{}] ", f.status),
            Style::default().fg(badge_color),
        );
        // Truncate long paths to avoid horizontal overflow.
        let max_path_len = 28usize;
        let path_display = if f.path.len() > max_path_len {
            format!("...{}", &f.path[f.path.len() - (max_path_len - 3)..])
        } else {
            f.path.clone()
        };
        let path_span = Span::raw(path_display);
        let counts = if f.added > 0 || f.removed > 0 {
            Span::styled(
                format!("  +{} -{}", f.added, f.removed),
                Style::default().fg(Color::DarkGray),
            )
        } else {
            Span::raw("")
        };
        ListItem::new(Line::from(vec![badge, path_span, counts]))
    }
    ```

    **Update `airev/src/ui/mod.rs`:**

    1. Add `pub mod diff_view;` and `pub mod file_tree;` at the top with the other module declarations.

    2. Replace the `render_file_list` inline function call with `file_tree::render_file_list(...)`.

    3. Replace the `render_diff` inline function call with `diff_view::render_diff(...)`.
       Update the `render_diff` function signature in `render()` to pass `state` instead of
       `&state` where needed (diff_view takes `&AppState` not `&mut AppState`).

    4. Remove the `build_diff_placeholder()` function entirely.

    5. Remove the `build_comments_placeholder()` function entirely (or keep comments panel as
       Paragraph placeholder — comments panel is Phase 4+, so keeping it as a simple placeholder
       Paragraph is fine, just remove the unused import if build_diff_placeholder is gone).

    6. Remove the inline `fn render_file_list` and `fn render_diff` private functions from mod.rs
       (they are now in their own modules). The `render_comments` function stays in mod.rs as a
       simple Paragraph placeholder — it is replaced in Phase 5.

    7. Update the `use` imports in `mod.rs` to remove now-unused items
       (`Text`, `Paragraph` if only used in removed functions).

    After all changes, run `cargo build -p airev`. Fix any:
    - Unused import warnings → remove them.
    - Missing `mut` on `state` in `render()` call to `render_file_list` → `render_file_list`
      takes `&mut AppState` for `ListState`. The `render()` function already takes `&mut AppState`.
    - `panel_block` takes `&str` not `String` → pass `title.as_str()` or change signature to
      accept `impl Into<&str>` or `&str`. If panel_block takes a `&str` already, use `&title`.

    Verify the TUI still launches and renders: `cargo run -p airev 2>/tmp/airev.log` — the
    diff panel should show "No diff loaded" and the file list should show "No files" (since no
    AsyncGit is started yet — that wiring comes in Plan 04).
  </action>
  <verify>
    `cargo build -p airev` exits 0 with zero errors.
    `grep "build_diff_placeholder\|build_comments_placeholder" airev/src/ui/mod.rs` returns empty.
    `grep "diff_view\|file_tree" airev/src/ui/mod.rs` shows both module declarations and calls.
    `cargo run -p airev 2>/dev/null` launches and shows the 3-panel layout (visual spot-check).
  </verify>
  <done>
    ui/diff_view.rs and ui/file_tree.rs exist and are called from ui/mod.rs. Placeholder builders
    removed. TUI still launches and renders the 3-panel layout. The diff panel shows "No diff loaded"
    and file list shows "No files" when no git data is available (expected until Plan 04 wires AsyncGit).
  </done>
</task>

</tasks>

<verification>
`cargo build --workspace` exits 0.
`grep -r "build_diff_placeholder\|build_comments_placeholder" airev/src/` returns empty.
`grep "Paragraph" airev/src/ui/diff_view.rs` returns empty (List only).
Virtual scroll slice: `diff_lines[visible_start..visible_end]` where visible_end ≤ diff_lines.len().
</verification>

<success_criteria>
- ui/diff_view.rs exists with render_diff using List + manual slice (no Paragraph)
- ui/file_tree.rs exists with render_file_list using FileSummary data and status badges
- ui/mod.rs calls both new modules; placeholder builders are removed
- cargo build --workspace exits 0
- TUI launches and shows "No diff loaded" / "No files" placeholders (correct before Plan 04 wiring)
</success_criteria>

<output>
After completion, create `.planning/phases/03-git-layer/03-03-SUMMARY.md`
</output>
