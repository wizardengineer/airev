---
phase: 03-git-layer
plan: 05
type: execute
wave: 5
depends_on: [03-04]
autonomous: false
files_modified: []
requirements:
  - Diff View
  - File List Panel
  - Diff Modes

must_haves:
  truths:
    - "Diff panel renders real git content in under 100ms for the first screenful"
    - "5000+ line diff scrolls at 60fps with no visible frame drops"
    - "All four diff modes load and display correctly"
    - "rustc confirms no git2::Repository crosses a thread boundary (no unsafe)"
    - "File list shows real changed files with M/A/D/R badges"
  artifacts:
    - path: "airev/src/git/worker.rs"
      provides: "Background thread with Repository — no unsafe, no thread-boundary crossing"
    - path: "airev/src/ui/diff_view.rs"
      provides: "Virtual scrolling diff panel at 60fps"
    - path: "airev/src/ui/file_tree.rs"
      provides: "Real file summaries with status badges"
  key_links:
    - from: "human"
      to: "terminal"
      via: "visual verification of rendering, fps, and mode switching"
      pattern: "user observes"
---

<objective>
Verify Phase 3 exit criteria with a real git repository. Confirm sub-100ms first-screenful load, 60fps scrolling on a large diff, all four diff modes functional, and zero unsafe blocks in the git layer.

Purpose: The compiler enforces the !Send constraint on git2::Repository, so the thread-boundary check is already verified by `cargo build`. The human checkpoint confirms performance and visual correctness that cannot be scripted.

Output: Signed-off Phase 3 — git layer rendering real content, verified at scale.
</objective>

<execution_context>
@/Users/juliusalexandre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/juliusalexandre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-git-layer/03-04-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:auto">
  <name>Task 1: Automated pre-checks before human verification</name>
  <files></files>
  <action>
    Run the following automated checks and confirm each passes before presenting the human
    verification checkpoint. Fix any failures before proceeding.

    **Check 1: No unsafe in git layer**
    ```bash
    grep -rn "unsafe" airev/src/git/
    ```
    Expected: no output (zero matches). If any unsafe block exists, it must be removed.
    The compiler enforces !Send on git2::Repository — no unsafe is needed or acceptable.

    **Check 2: cargo build --workspace exits 0**
    ```bash
    cargo build --workspace 2>&1
    echo "Exit code: $?"
    ```
    Expected: exit code 0, zero errors.

    **Check 3: No E0277 (Send) violations**
    ```bash
    cargo check --workspace 2>&1 | grep E0277
    ```
    Expected: empty output.

    **Check 4: Repository opened inside thread (not passed in)**
    ```bash
    grep -n "Repository::open\|Repository::discover" airev/src/git/worker.rs
    ```
    Expected: `Repository::open` appears in `worker.rs` (opened inside the thread), not in `mod.rs`.
    `Repository::discover` should only appear in `main.rs` for path resolution.

    **Check 5: diff_scroll is usize in AppState**
    ```bash
    grep "diff_scroll" airev/src/app.rs | head -5
    ```
    Expected: `pub diff_scroll: usize` (not u16).

    **Check 6: Virtual scroll slice is bounded**
    ```bash
    grep "visible_start\|visible_end" airev/src/ui/diff_view.rs
    ```
    Expected: both are present and visible_end uses `.min(total)` to prevent out-of-bounds panic.

    Report results of all six checks. If all pass, proceed to the human checkpoint. If any fail,
    fix the issue and re-run before proceeding.
  </action>
  <verify>
    All 6 checks above pass: no unsafe, cargo build exits 0, no E0277, Repository::open in worker.rs,
    diff_scroll is usize, virtual scroll uses bounded slice.
  </verify>
  <done>All automated pre-checks pass. Ready for human verification.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification — Phase 3 exit criteria</name>
  <what-built>
    Complete Phase 3 Git Layer:
    - Background thread owning git2::Repository (never crosses thread boundary)
    - Four diff modes: Unstaged (Tab→) Staged (Tab→) Branch (Tab→) Range (Tab→) Unstaged
    - Diff panel with virtual List scrolling showing syntax-highlighted git output
    - File list panel with real M/A/D/R file summaries
    - Status bar showing current diff mode and "Computing diff..." loading indicator
    - Enter/l jumps from file list to diff panel for that file
    - [ and ] navigate between @@ hunk headers
  </what-built>
  <how-to-verify>
    Open a git repository with at least 10 changed files. A large open-source repo works well
    (e.g., any active project with staged or unstaged changes). Run:

    ```bash
    cargo run -p airev
    ```

    Verify each item in order:

    **1. Real diff content loads**
    - Diff panel shows syntax-highlighted lines (not "No diff loaded")
    - File list panel shows real filenames with [M]/[A]/[D] badges
    - Status bar shows `NORMAL | UNSTAGED`

    **2. First screenful loads quickly**
    - From launch to first visible diff content: should be under 1 second for most repos
    - You may see "Computing diff..." briefly in the status bar, then content appears

    **3. Scrolling performance at scale (ROADMAP exit criterion: 100+ changed files, 5000+ line diff)**
    - The diff must be tested against a repo with at least 100 changed files and a 5000+ line diff.
    - If your current working repo does not meet this threshold, clone a large open-source repo
      (e.g., `git clone https://github.com/tokio-rs/tokio /tmp/tokio-test`) and run
      `cargo run -p airev` from that directory with staged or unstaged changes of sufficient scale.
    - With the large diff loaded, hold down `j` for 3 seconds — the panel must scroll smoothly
      without visible stutter or frame drops. The virtual scrolling implementation is O(viewport),
      so performance must not degrade with diff size.

    **4. All four diff modes work**
    - Press `Tab` → status bar changes to `STAGED`; diff panel reloads (may briefly show "Computing diff...")
    - Press `Tab` again → `BRANCH` mode; shows main..HEAD diff (may be empty if HEAD is clean)
    - Press `Tab` again → `RANGE` mode (CommitRange — may show empty diff as it needs two refs)
    - Press `Tab` again → back to `UNSTAGED`

    **5. File list navigation and jump**
    - Press `H` to focus the file list (left panel border brightens)
    - Navigate with `j`/`k` to select a file
    - Press `Enter` or `l` → diff panel updates to show that file's changes and focus moves to Diff
    - File count shown in "Files (N)" panel title

    **6. Hunk navigation**
    - Press `L` to focus the diff panel
    - Press `]` → diff_scroll jumps to the next @@ hunk header
    - Press `[` → jumps back to previous @@ header
    - Press `g` → scroll to top; press `G` → scroll to bottom

    **7. No crashes**
    - Navigate aggressively: rapid Tab presses, g/G, Ctrl-d/Ctrl-u
    - Resize the terminal during a live session
    - Open outside a git repo (e.g., `cd /tmp && cargo run --manifest-path ...`) — should show
      "No diff loaded" gracefully, not crash

    **8. Compiler thread-safety check (already confirmed by cargo build in Task 1)**
    - `grep -r "unsafe" airev/src/git/` must be empty — the compiler enforced this
  </how-to-verify>
  <resume-signal>
    Type "approved" if all 8 items pass, or describe what failed (e.g., "mode 3 shows empty diff",
    "scrolling stutters on large diff", "crash when pressing Tab rapidly") so gaps can be diagnosed.
  </resume-signal>
  <action>Human runs `cargo run -p airev` in a git repository and performs the 8 verification steps above.</action>
  <verify>All 8 steps pass. User types "approved".</verify>
  <done>Phase 3 exit criteria confirmed: real diff content, 60fps scrolling, all 4 diff modes functional, no unsafe, file jump and hunk nav working, graceful no-repo behavior.</done>
</task>

</tasks>

<verification>
Human signs off on all 8 verification items above.
</verification>

<success_criteria>
- All 6 automated pre-checks pass (no unsafe, cargo build 0, E0277 absent, Repository in worker, usize scroll, bounded slice)
- Human confirms: real diff content, sub-1s load, smooth scrolling, all 4 modes, file jump, hunk nav, no crashes
- Phase 3 exit criteria from ROADMAP.md are met: real content, 60fps scrolling, 4 diff modes, compiler-enforced thread safety
</success_criteria>

<output>
After completion, create `.planning/phases/03-git-layer/03-05-SUMMARY.md`

Also update `.planning/STATE.md`:
- Set Phase to `03-git-layer (complete)`
- Mark Phase 3 as complete in the Phase Progress table
- Set Next Step to: "Execute Phase 4: Persistence Layer (`04-persistence-layer`). Begin with plan 01."
- Add key decisions from this phase to the Key Decisions Locked section
</output>
