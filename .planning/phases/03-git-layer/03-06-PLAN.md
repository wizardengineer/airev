---
phase: 03-git-layer
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - airev/src/git/worker.rs
  - airev/src/git/types.rs
  - airev/src/app.rs
  - airev/src/ui/layout.rs
autonomous: true
requirements:
  - File List Panel
gap_closure: true

must_haves:
  truths:
    - "File list panel shows +N/-N line counts per file (non-zero for files with changes)"
    - "Enter or l on file list jumps diff_scroll to the selected file's first hunk, not to line 0"
    - "Status bar displays file count (e.g., '12 files') alongside diff mode and loading indicator"
  artifacts:
    - path: "airev/src/git/worker.rs"
      provides: "Populated added/removed counts in extract_files; file_line_offsets computed in process_diff"
      contains: "file_line_offsets"
    - path: "airev/src/git/types.rs"
      provides: "file_line_offsets field on GitResultPayload"
      contains: "file_line_offsets"
    - path: "airev/src/app.rs"
      provides: "file_line_offsets stored in AppState; jump_to_selected_file uses offset lookup"
      contains: "file_line_offsets"
    - path: "airev/src/ui/layout.rs"
      provides: "File count span in render_status_bar"
      contains: "files"
  key_links:
    - from: "airev/src/git/worker.rs"
      to: "airev/src/git/types.rs"
      via: "file_line_offsets field populated in process_diff"
      pattern: "file_line_offsets"
    - from: "airev/src/app.rs"
      to: "airev/src/git/types.rs"
      via: "apply_git_result stores file_line_offsets; jump_to_selected_file reads it"
      pattern: "file_line_offsets\\[.*\\]"
---

<objective>
Close the three verification gaps blocking full File List Panel requirement satisfaction in Phase 3.

Purpose: Phase 3 verification found 3 gaps (2 blocking, 1 cosmetic) preventing the File List Panel requirement from being fully met. This plan fixes all three with targeted surgical changes.

Output: All three gaps closed — line counts populated, file jump navigates to correct offset, status bar shows file count.
</objective>

<execution_context>
@/Users/juliusalexandre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/juliusalexandre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-git-layer/03-VERIFICATION.md
@airev/src/git/worker.rs
@airev/src/git/types.rs
@airev/src/app.rs
@airev/src/ui/layout.rs
@airev/src/ui/file_tree.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Populate per-file added/removed line counts in extract_files</name>
  <files>airev/src/git/worker.rs</files>
  <action>
    Replace the `extract_files()` function to compute real added/removed line counts instead of hardcoded zeroes.

    The current implementation at line ~186 returns `FileSummary { path, status, added: 0, removed: 0 }` for every file.

    Fix approach: Use `diff.stats()` or iterate `diff.foreach()` to count `+` and `-` origin lines per file path. The simplest correct approach:

    1. After collecting deltas into `Vec<FileSummary>` with zeroed counts, make a second pass using `diff.foreach()` with all four callbacks:
       - file_cb: track current file index by matching the delta's new_file path against the FileSummary vec
       - hunk_cb: no-op (return true)
       - line_cb: increment `added` for origin `'+'` and `removed` for origin `'-'` on the current file

    Alternatively (simpler): Build a `HashMap<String, (usize, usize)>` during `extract_hunks()` by counting `+`/`-` origins per file path from the delta callback, then merge counts into `FileSummary` in `process_diff()`. This avoids a second `diff.foreach()` call.

    Preferred approach (cleanest): Change `extract_files()` to accept the already-extracted `&[OwnedDiffHunk]` is NOT viable because hunks don't carry file paths. Instead, use `diff.foreach()` inside `extract_files()` itself with all four callbacks to count lines per delta. Replace the current `.deltas().map()` implementation:

    ```rust
    fn extract_files(diff: &Diff<'_>) -> Vec<FileSummary> {
        use std::cell::RefCell;
        let files: RefCell<Vec<FileSummary>> = RefCell::new(Vec::new());

        let _ = diff.foreach(
            &mut |delta, _progress| {
                let path = delta
                    .new_file()
                    .path()
                    .unwrap_or(std::path::Path::new("unknown"))
                    .to_string_lossy()
                    .into_owned();
                let status = match delta.status() {
                    Delta::Added => 'A',
                    Delta::Deleted => 'D',
                    Delta::Renamed => 'R',
                    _ => 'M',
                };
                files.borrow_mut().push(FileSummary {
                    path, status, added: 0, removed: 0,
                });
                true
            },
            None, // binary_cb
            None, // hunk_cb
            Some(&mut |_delta, _hunk, line| {
                let mut files = files.borrow_mut();
                if let Some(f) = files.last_mut() {
                    match line.origin() {
                        '+' => f.added += 1,
                        '-' => f.removed += 1,
                        _ => {}
                    }
                }
                true
            }),
        );

        files.into_inner()
    }
    ```

    Update the doc comment to remove the "Line counts are left as 0" note.

    The existing `file_summary_item()` in `file_tree.rs` already handles display via the `if f.added > 0 || f.removed > 0` guard — no changes needed there.
  </action>
  <verify>
    `cargo build --workspace` exits 0. Run `cargo run -p airev` in a git repo with changes and confirm the file list shows `+N -M` counts next to filenames (not blank).
  </verify>
  <done>
    Every FileSummary has real added/removed counts. The file list panel renders "+N -M" for files with changes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Compute per-file line offsets and fix jump_to_selected_file</name>
  <files>airev/src/git/types.rs, airev/src/git/worker.rs, airev/src/app.rs</files>
  <action>
    Three files need coordinated changes:

    **1. `airev/src/git/types.rs` — Add `file_line_offsets` to `GitResultPayload`:**

    Add a new field after `hunk_offsets`:
    ```rust
    /// Starting line index in `highlighted_lines` for each file.
    ///
    /// `file_line_offsets[i]` is the line index where file `i`'s first hunk header
    /// appears in `highlighted_lines`. Used by `jump_to_selected_file()` to scroll
    /// the diff panel to the correct position.
    pub file_line_offsets: Vec<usize>,
    ```

    **2. `airev/src/git/worker.rs` — Compute `file_line_offsets` in `process_diff()`:**

    The key insight: `extract_files()` gives us one `FileSummary` per delta, and `highlight_hunks()` emits lines in delta order. We need to map each file to its first line in `highlighted_lines`.

    Approach: In `highlight_hunks()`, track file boundaries. The `diff.foreach()` in `extract_hunks()` visits deltas in order, creating hunks per file. We can compute file offsets by correlating hunks to files.

    Simpler approach: After `highlight_hunks()` returns, scan `highlighted_lines` for `@@` hunk headers and correlate them to files by tracking which file's hunks have been seen. But this is fragile.

    Best approach: Modify `highlight_hunks()` to also accept the `hunks` grouped by file. But hunks don't carry file paths.

    Pragmatic approach: Modify `extract_hunks()` to also return a `Vec<usize>` of per-file hunk start indices (i.e., which hunk index starts a new file). Then in `process_diff()`, map those to line offsets via `hunk_offsets`.

    Actually, the cleanest approach: Track file boundaries in `extract_hunks()` using the file callback. The file callback fires once per delta (file). Record the hunk index at each file boundary. Then in `process_diff()`, convert those hunk indices to line indices via `hunk_offsets`.

    Implementation:

    a) Change `extract_hunks()` to return `(Vec<OwnedDiffHunk>, Vec<usize>)` where the second vec is `file_hunk_starts` — the index into the hunk vec where each file's hunks begin.

    In `extract_hunks()`, add a second RefCell counter:
    ```rust
    let file_hunk_starts: RefCell<Vec<usize>> = RefCell::new(Vec::new());
    ```
    In the file callback (`&mut |_, _| true`), change to:
    ```rust
    &mut |_delta, _progress| {
        file_hunk_starts.borrow_mut().push(hunks.borrow().len());
        true
    },
    ```

    Return `(hunks.into_inner(), file_hunk_starts.into_inner())`.

    b) In `process_diff()`, update the call:
    ```rust
    let (hunks, file_hunk_starts) = extract_hunks(diff);
    ```
    After `highlight_hunks()` returns `(highlighted_lines, hunk_offsets)`, compute:
    ```rust
    let file_line_offsets: Vec<usize> = file_hunk_starts
        .iter()
        .map(|&hunk_idx| {
            hunk_offsets.get(hunk_idx).copied().unwrap_or(0)
        })
        .collect();
    ```
    Add `file_line_offsets` to the returned `GitResultPayload`.

    c) Update the empty-payload fallback in `handle_request()` to include `file_line_offsets: Vec::new()`.

    **3. `airev/src/app.rs` — Store offsets and use them in jump:**

    a) Add field to `AppState`:
    ```rust
    /// Per-file starting line offsets in diff_lines, for file-list jump navigation.
    pub file_line_offsets: Vec<usize>,
    ```
    Initialize to `Vec::new()` in `Default`.

    b) In `apply_git_result()`, store the offsets:
    ```rust
    self.file_line_offsets = payload.file_line_offsets;
    ```

    c) Fix `jump_to_selected_file()`:
    ```rust
    pub fn jump_to_selected_file(&mut self) {
        if let Some(idx) = self.file_list_state.selected() {
            self.selected_file_index = idx;
            self.diff_scroll = self
                .file_line_offsets
                .get(idx)
                .copied()
                .unwrap_or(0);
            self.hunk_cursor = 0;
            self.focus = PanelFocus::Diff;
        }
    }
    ```
    Update the doc comment to say "Jumps diff view to the selected file's first hunk" instead of "resets diff_scroll to 0".
  </action>
  <verify>
    `cargo build --workspace` exits 0. Run `cargo run -p airev` in a repo with multiple changed files. Select different files in the file list and press Enter — confirm the diff panel scrolls to that file's section, not to line 0.
  </verify>
  <done>
    Enter/l on any file in the file list scrolls the diff panel to that file's first hunk header. The second file does NOT show the same position as the first file.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add file count to status bar</name>
  <files>airev/src/ui/layout.rs</files>
  <action>
    In `render_status_bar()`, add a file count span after the diff mode label and before the loading indicator.

    After the `diff_mode_label` span is pushed (around line 164), add:
    ```rust
    if !state.file_summaries.is_empty() {
        spans.push(Span::raw("  |  "));
        spans.push(Span::styled(
            format!("{} files", state.file_summaries.len()),
            Style::default().fg(Color::DarkGray),
        ));
    }
    ```

    This inserts "12 files" between the diff mode label and the loading indicator, separated by the same `|` separator used elsewhere in the status bar.

    Update the doc comment for `render_status_bar` to mention the file count display.

    Note: The file count in the panel title ("Files (12)") in `file_tree.rs` should be kept as-is — it is useful visual information there too.
  </action>
  <verify>
    `cargo build --workspace` exits 0. Run `cargo run -p airev` in a git repo with changes and confirm the status bar shows "NORMAL  |  UNSTAGED  |  12 files" (with the actual count).
  </verify>
  <done>
    Status bar shows file count alongside the diff mode label, matching the ROADMAP Phase 3 Delivers specification ("file count in status bar").
  </done>
</task>

</tasks>

<verification>
After all three tasks are complete:

1. `cargo build --workspace` exits 0 with no new warnings related to the changed code
2. `cargo run -p airev` in a git repo with multiple changed files shows:
   - File list entries have "+N -M" line counts (Gap 1 closed)
   - Enter/l on different files scrolls to different positions in the diff (Gap 2 closed)
   - Status bar shows file count (Gap 3 closed)
3. All 18 truths from 03-VERIFICATION.md now pass (the 3 that were failed/partial are fixed)
</verification>

<success_criteria>
All three verification gaps from 03-VERIFICATION.md are closed:
- Gap 1: FileSummary.added and .removed are populated with real counts from diff line origins
- Gap 2: jump_to_selected_file() uses file_line_offsets lookup instead of hardcoded 0
- Gap 3: render_status_bar() includes file count span
- `cargo build --workspace` exits 0
</success_criteria>

<output>
After completion, create `.planning/phases/03-git-layer/03-06-SUMMARY.md`
</output>
