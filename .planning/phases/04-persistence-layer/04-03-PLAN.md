---
phase: 04-persistence-layer
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - airev/src/ui/keybindings.rs
  - airev/src/ui/file_tree.rs
  - airev/src/ui/help.rs
autonomous: false
requirements:
  - mark_file_reviewed
  - Session lifecycle

must_haves:
  truths:
    - "Pressing r on a focused file in the file list toggles its reviewed state in the DB"
    - "Reviewed files show a checkmark in the file list panel"
    - "Review state persists across restart — quit and reopen shows the same checkmarks"
    - "Concurrent writes from two processes cause no SQLITE_BUSY errors"
    - "Help overlay lists the r keybinding for toggling file review"
  artifacts:
    - path: "airev/src/ui/keybindings.rs"
      provides: "r keybinding handler spawning async DB toggle"
      contains: "toggle_file_reviewed"
    - path: "airev/src/ui/file_tree.rs"
      provides: "Checkmark rendering for reviewed files"
      contains: "reviewed"
  key_links:
    - from: "airev/src/ui/keybindings.rs"
      to: "airev-core/src/db.rs"
      via: "tokio::spawn calling toggle_file_reviewed()"
      pattern: "toggle_file_reviewed"
    - from: "airev/src/ui/file_tree.rs"
      to: "airev/src/app.rs"
      via: "reads state.file_review_states for checkmark display"
      pattern: "file_review_states"
    - from: "airev/src/ui/keybindings.rs"
      to: "airev/src/event.rs"
      via: "spawned task sends DbResultPayload::ReviewToggled over event_tx"
      pattern: "DbResultPayload::ReviewToggled"
---

<objective>
Wire the mark_file_reviewed keybinding (`r`), render checkmarks on reviewed files in the file list,
update help overlay, and run exit criteria verification (persistence across restart, concurrent
write safety).

Purpose: This completes Phase 4 — the user can navigate files, mark them reviewed, quit, reopen,
and see the same reviewed state. The full session + review lifecycle is exercised end-to-end.

Output: Updated keybindings.rs, file_tree.rs, help.rs; verified persistence and concurrency.
</objective>

<execution_context>
@/Users/juliusalexandre/.claude/get-shit-done/workflows/execute-plan.md
@/Users/juliusalexandre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-persistence-layer/04-RESEARCH.md
@.planning/phases/04-persistence-layer/04-01-SUMMARY.md
@.planning/phases/04-persistence-layer/04-02-SUMMARY.md
@airev/src/ui/keybindings.rs
@airev/src/ui/file_tree.rs
@airev/src/ui/help.rs
@airev/src/app.rs
@airev/src/event.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire r keybinding for toggle_file_reviewed and render checkmarks in file list</name>
  <files>airev/src/ui/keybindings.rs, airev/src/ui/file_tree.rs, airev/src/ui/help.rs</files>
  <action>
**keybindings.rs changes:**

Add import at top: `use crate::event::{AppEvent, DbResultPayload};`

In `handle_file_list_key()`, add a new arm for `KeyCode::Char('r')` when focused on the file list (before the `_ => None` arm):

```rust
// Toggle file reviewed state (r key, file list panel only).
KeyCode::Char('r') if state.focus == PanelFocus::FileList => {
    handle_toggle_review(state);
    Some(KeyAction::Continue)
}
```

Add a new private helper function `handle_toggle_review()`:

```rust
/// Spawns an async DB task to toggle the reviewed state of the currently selected file.
///
/// Clones `db_conn` and `event_tx` from AppState (both are cheap Arc clones), then
/// spawns a tokio task that calls `toggle_file_reviewed()` and sends the result back
/// as `AppEvent::DbResult(DbResultPayload::ReviewToggled)`. Does nothing if no DB
/// connection, no session, or no file is selected.
fn handle_toggle_review(state: &mut AppState) {
    let conn = match state.db_conn.as_ref() {
        Some(c) => c.clone(),
        None => return,
    };
    let session_id = match state.session.as_ref() {
        Some(s) => s.id.clone(),
        None => return,
    };
    let file_path = match state.current_file_path() {
        Some(p) => p.to_owned(),
        None => return,
    };
    let tx = match state.event_tx.as_ref() {
        Some(t) => t.clone(),
        None => return,
    };

    // Optimistic UI update: toggle immediately in memory so the checkmark
    // appears before the DB round-trip completes.
    let current = state.file_review_states.get(&file_path).copied().unwrap_or(false);
    state.file_review_states.insert(file_path.clone(), !current);

    tokio::spawn(async move {
        match airev_core::db::toggle_file_reviewed(&conn, &session_id, &file_path).await {
            Ok(reviewed) => {
                let _ = tx.send(AppEvent::DbResult(Box::new(
                    DbResultPayload::ReviewToggled { file_path, reviewed },
                )));
            }
            Err(e) => {
                // Log to stderr (the terminal backend) — visible in debug but not
                // disruptive in normal use since stderr IS the terminal.
                eprintln!("airev: DB toggle error: {e}");
            }
        }
    });
}
```

Note: the optimistic update means the checkmark appears instantly; the DbResult event will confirm or correct the state when the DB write completes. This avoids a visible delay.

**file_tree.rs changes:**

Modify `render_file_list()` to pass `&state.file_review_states` into the item builder. Change the `file_summaries.iter().map(...)` call to also check review state:

```rust
state.file_summaries.iter().map(|f| {
    let reviewed = state.file_review_states.get(&f.path).copied().unwrap_or(false);
    file_summary_item(f, reviewed, theme)
}).collect()
```

Update `file_summary_item` signature to accept `reviewed: bool`:

```rust
fn file_summary_item(f: &FileSummary, reviewed: bool, _theme: &Theme) -> ListItem<'static> {
```

Add a checkmark prefix before the badge when `reviewed` is true:

```rust
let review_mark = if reviewed {
    Span::styled("[x] ", Style::default().fg(Color::Green))
} else {
    Span::styled("[ ] ", Style::default().fg(Color::DarkGray))
};
```

Include `review_mark` as the first span in the Line:

```rust
ListItem::new(Line::from(vec![review_mark, badge, path_span, counts]))
```

Add import for `std::collections::HashMap` if needed (it is accessed via `state.file_review_states` which is already a HashMap on AppState).

**help.rs changes:**

In the help text content (the keybinding list), add a line for the `r` key:

```
r             Toggle file reviewed (file list)
```

Place it in the File List navigation section, after the `Enter/l` and `Tab` entries.
  </action>
  <verify>`cargo build --workspace 2>&1 | tail -10` shows no errors. `grep "toggle_file_reviewed" airev/src/ui/keybindings.rs | wc -l` returns at least 1. `grep "reviewed" airev/src/ui/file_tree.rs | wc -l` returns at least 3. `grep "r  " airev/src/ui/help.rs | head -1` shows the toggle keybinding.</verify>
  <done>Pressing r on a file in the file list toggles its reviewed state via async DB write. File list renders [x]/[ ] checkmarks. Help overlay documents the r keybinding. Workspace compiles cleanly.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Phase 4 exit criteria verification</name>
  <what-built>
Complete persistence layer: SQLite v1 schema with UUID text IDs and schema versioning, session
detect/resume lifecycle, file review toggle with checkmarks, status bar session display. All DB
access via tokio-rusqlite Connection::call() with BEGIN IMMEDIATE writes.
  </what-built>
  <how-to-verify>
**Automated pre-checks (run these first):**

1. `cargo build --workspace` — must succeed with zero errors
2. `sqlite3 .airev/reviews.db "PRAGMA journal_mode;"` — must return `wal`
3. `sqlite3 .airev/reviews.db "SELECT * FROM schema_version;"` — must return `1`
4. `sqlite3 .airev/reviews.db "SELECT * FROM threads;"` — must return empty result (table exists)
5. `sqlite3 .airev/reviews.db ".schema sessions"` — must show `id TEXT PRIMARY KEY` (not INTEGER)
6. `sqlite3 .airev/reviews.db ".schema file_review_state"` — must show composite PK on (session_id, file_path)
7. `grep -c "TransactionBehavior::Immediate" airev-core/src/db.rs` — must be >= 3

**Human verification steps:**

1. Run `cargo run -p airev` in this repo (or any repo with changes)
2. Confirm status bar shows "Session: xxxxxxxx..." (8-char UUID prefix)
3. Navigate to the file list panel (H key if not already focused)
4. Press `r` on a file — confirm a `[x]` checkmark appears next to the file name
5. Press `r` again on the same file — confirm the checkmark toggles back to `[ ]`
6. Mark two different files as reviewed (press `r` on each)
7. Quit with `q`
8. Run `sqlite3 .airev/reviews.db "SELECT file_path, reviewed FROM file_review_state;"` — confirm the two files show `reviewed = 1`
9. Run `cargo run -p airev` again in the same repo
10. Confirm the two previously-reviewed files still show `[x]` checkmarks (persistence verified)
11. Confirm the session count is still 1: `sqlite3 .airev/reviews.db "SELECT COUNT(*) FROM sessions;"` — should return `1`
12. Press `?` for help overlay — confirm `r` keybinding is documented
13. Run the concurrent write test: open two terminal windows, run `cargo run -p airev` in both pointing at the same repo. Toggle reviews in both. Quit both. Check stderr output for any SQLITE_BUSY errors (there should be none).
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 4, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
**Phase 4 Exit Criteria (from ROADMAP.md):**

1. Start a session, navigate the diff, mark two files as reviewed, quit — VERIFIED by human steps 1-7
2. Reopen the tool in the same repo and confirm the session resumes with the reviewed state intact — VERIFIED by human steps 9-10
3. Inspect the database directly with `sqlite3 .airev/reviews.db "SELECT * FROM threads;"` and confirm the schema matches the multi-round design — VERIFIED by automated check 4
4. Run concurrent writes from two processes and confirm no SQLITE_BUSY errors appear in stderr — VERIFIED by human step 13
</verification>

<success_criteria>
- r keybinding toggles file reviewed state with instant visual feedback (optimistic UI)
- Reviewed files show [x] checkmarks in the file list panel
- Review state persists: quit and reopen shows same checkmarks
- Session is resumed (not duplicated) on subsequent launches
- Schema matches multi-round design (threads table exists)
- No SQLITE_BUSY errors under concurrent access
- Help overlay documents the r keybinding
- All automated pre-checks pass before human verification
</success_criteria>

<output>
After completion, create `.planning/phases/04-persistence-layer/04-03-SUMMARY.md`
</output>
